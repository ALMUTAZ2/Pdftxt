  <!DOCTYPE html>
  <html dir="rtl">
  <head>
      <meta charset="UTF-8">
      <title>محرر نصوص PDF المتقدم</title>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
      <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
      <style>
          body {
              font-family: Arial, sans-serif;
              margin: 20px;
              background-color: #f5f5f5;
          }
          .container {
              max-width: 1200px;
              margin: 0 auto;
              background-color: white;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 0 10px rgba(0,0,0,0.1);
          }
          .workspace {
              display: flex;
              gap: 20px;
              margin-top: 20px;
          }
          .text-panel {
              flex: 1;
              background-color: #f8f9fa;
              padding: 15px;
              border-radius: 8px;
              max-width: 300px;
          }
          .preview-panel {
              flex: 2;
          }
          .text-item {
              padding: 10px;
              margin: 5px 0;
              background-color: white;
              border: 1px solid #ddd;
              border-radius: 4px;
              cursor: pointer;
              transition: background-color 0.2s;
          }
          .text-item:hover {
              background-color: #e9ecef;
          }
          .text-item.selected {
              background-color: #cce5ff;
              border-color: #b8daff;
          }
          .editor-controls {
              margin: 20px 0;
              padding: 15px;
              background-color: #f8f9fa;
              border-radius: 4px;
          }
          button {
              background-color: #4CAF50;
              color: white;
              padding: 8px 16px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              margin: 5px;
          }
          button:hover {
              background-color: #45a049;
          }
          button:disabled {
              background-color: #cccccc;
              cursor: not-allowed;
          }
          input[type="text"], input[type="file"] {
              width: 100%;
              padding: 8px;
              margin: 5px 0;
              border: 1px solid #ddd;
              border-radius: 4px;
          }
          .status {
              padding: 10px;
              margin: 10px 0;
              border-radius: 4px;
          }
          .success {
              background-color: #d4edda;
              color: #155724;
          }
          .error {
              background-color: #f8d7da;
              color: #721c24;
          }
          #pdfPreview {
              width: 100%;
              height: 800px;
              border: 1px solid #ddd;
          }
          .text-info {
              font-size: 0.9em;
              color: #666;
              margin-top: 5px;
          }
          .loading {
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: rgba(255, 255, 255, 0.9);
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 0 10px rgba(0,0,0,0.1);
              display: none;
          }
      </style>
  </head>
  <body>
      <div class="container">
          <h1>محرر نصوص PDF</h1>
          
          <div class="editor-controls">
              <input type="file" id="pdfFile" accept=".pdf" />
              <button onclick="loadPDF()">فتح الملف</button>
          </div>

          <div id="statusMessage" class="status"></div>

          <div class="workspace">
              <div class="text-panel">
                  <h3>النصوص في الملف</h3>
                  <div id="textList"></div>
              </div>

              <div class="preview-panel">
                  <div class="editor-controls">
                      <h3>تعديل النص المحدد</h3>
                      <div>
                          <label>النص الأصلي:</label>
                          <input type="text" id="originalText" readonly />
                          <div id="textInfo" class="text-info"></div>
                      </div>
                      <div>
                          <label>النص الجديد:</label>
                          <input type="text" id="newText" />
                      </div>
                      <button onclick="applyEdit()" id="editButton" disabled>تطبيق التعديل</button>
                  </div>
                  
                  <iframe id="pdfPreview"></iframe>
              </div>
          </div>

          <div id="loadingMessage" class="loading">جاري المعالجة...</div>
      </div>

      <script>
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

          let pdfDocument = null;
          let pdfBytes = null;
          let textItems = [];
          let selectedTextItem = null;

          function showLoading(show = true) {
              document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
          }

          function showStatus(message, isError = false) {
              const status = document.getElementById('statusMessage');
              status.textContent = message;
              status.className = `status ${isError ? 'error' : 'success'}`;
          }

          async function loadPDF() {
              const fileInput = document.getElementById('pdfFile');
              const file = fileInput.files[0];
              
              if (!file) {
                  showStatus('الرجاء اختيار ملف PDF', true);
                  return;
              }

              showLoading(true);

              try {
                  const arrayBuffer = await file.arrayBuffer();
                  pdfBytes = new Uint8Array(arrayBuffer);

                  // تحميل PDF وعرضه
                  pdfDocument = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                  
                  // استخراج النصوص من جميع الصفحات
                  textItems = [];
                  for (let pageNum = 1; pageNum <= pdfDocument.numPages; pageNum++) {
                      const page = await pdfDocument.getPage(pageNum);
                      const textContent = await page.getTextContent();
                      textItems.push(...textContent.items.map(item => ({
                          ...item,
                          pageNum,
                          fontSize: item.transform[0],
                          fontFamily: item.fontName
                      })));
                  }

                  // عرض النصوص في القائمة
                  displayTextList();
                  
                  // عرض PDF في الـ iframe
                  const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                  const url = URL.createObjectURL(blob);
                  document.getElementById('pdfPreview').src = url;

                  showStatus('تم تحميل الملف بنجاح');

              } catch (error) {
                  console.error(error);
                  showStatus('حدث خطأ أثناء تحميل الملف', true);
              } finally {
                  showLoading(false);
              }
          }

          function displayTextList() {
              const container = document.getElementById('textList');
              container.innerHTML = '';

              textItems.forEach((item, index) => {
                  if (item.str.trim()) {  // عرض النصوص غير الفارغة فقط
                      const div = document.createElement('div');
                      div.className = 'text-item';
                      div.textContent = item.str;
                      div.onclick = () => selectText(item, index);
                      container.appendChild(div);
                  }
              });
          }

          function selectText(item, index) {
              selectedTextItem = { ...item, index };
              
              // تحديث الواجهة
              document.querySelectorAll('.text-item').forEach(el => 
                  el.classList.remove('selected')
              );
              document.querySelectorAll('.text-item')[index].classList.add('selected');
              
              // عرض معلومات النص
              document.getElementById('originalText').value = item.str;
              document.getElementById('newText').value = item.str;
              document.getElementById('textInfo').textContent = 
                  `الصفحة: ${item.pageNum} | حجم الخط: ${Math.round(item.fontSize)}px | نوع الخط: ${item.fontFamily}`;
              
              document.getElementById('editButton').disabled = false;
          }

          async function applyEdit() {
              if (!selectedTextItem) {
                  showStatus('الرجاء تحديد نص للتعديل', true);
                  return;
              }

              const newText = document.getElementById('newText').value;
              if (!newText) {
                  showStatus('الرجاء إدخال النص الجديد', true);
                  return;
              }

              showLoading(true);

              try {
                  // تحميل PDF باستخدام PDF-LIB
                  const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                  const page = pdfDoc.getPages()[selectedTextItem.pageNum - 1];

                  // إضافة النص الجديد
                  const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                  
                  // حذف النص القديم (إضافة مستطيل أبيض فوقه)
                  page.drawRectangle({
                      x: selectedTextItem.transform[4],
                      y: selectedTextItem.transform[5],
                      width: selectedTextItem.width,
                      height: selectedTextItem.height,
                      color: PDFLib.rgb(1, 1, 1),  // أبيض
                  });

                  // إضافة النص الجديد
                  page.drawText(newText, {
                      x: selectedTextItem.transform[4],
                      y: selectedTextItem.transform[5],
                      size: selectedTextItem.fontSize,
                      font: font
                  });

                  // حفظ التغييرات
                  const modifiedPdfBytes = await pdfDoc.save();
                  
                  // تحديث العرض والتحميل
                  const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
                  const url = URL.createObjectURL(blob);
                  
                  // تحديث المعاينة
                  document.getElementById('pdfPreview').src = url;
                  
                  // إنشاء رابط التحميل
                  const link = document.createElement('a');
                  link.href = url;
                  link.download = 'modified.pdf';
                  link.click();

                  showStatus('تم تعديل النص بنجاح');
                  
                  // تحديث البيانات المحلية
                  pdfBytes = modifiedPdfBytes;
                  await loadPDF();  // إعادة تحميل الملف لتحديث قائمة النصوص

              } catch (error) {
                  console.error(error);
                  showStatus('حدث خطأ أثناء تعديل النص: ' + error.message, true);
              } finally {
                  showLoading(false);
              }
          }
      </script>
  </body>
  </html>
