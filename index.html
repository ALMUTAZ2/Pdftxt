  <!DOCTYPE html>
  <html dir="rtl">
  <head>
      <meta charset="UTF-8">
      <title>محرر نصوص PDF</title>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <style>
          body {
              font-family: Arial, sans-serif;
              margin: 20px;
              background-color: #f5f5f5;
          }
          .container {
              max-width: 900px;
              margin: 0 auto;
              background-color: white;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 0 10px rgba(0,0,0,0.1);
          }
          button {
              background-color: #4CAF50;
              color: white;
              padding: 10px 20px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              margin: 5px;
          }
          button:hover {
              background-color: #45a049;
          }
          .editor-panel {
              margin: 15px 0;
              padding: 15px;
              background-color: #f8f9fa;
              border-radius: 4px;
          }
          .text-input {
              width: 100%;
              padding: 8px;
              margin: 10px 0;
              border: 1px solid #ddd;
              border-radius: 4px;
          }
          #textLayer {
              position: absolute;
              left: 0;
              top: 0;
              right: 0;
              bottom: 0;
              overflow: hidden;
              line-height: 1.0;
              pointer-events: none;
          }
          #annotationLayer {
              position: absolute;
              left: 0;
              top: 0;
              right: 0;
              bottom: 0;
              overflow: hidden;
          }
          .canvas-container {
              position: relative;
              margin-top: 20px;
              border: 1px solid #ddd;
          }
          .text-element {
              position: absolute;
              cursor: pointer;
              padding: 2px;
              border-radius: 2px;
          }
          .text-element:hover {
              background-color: rgba(255, 255, 0, 0.3);
          }
          .selected {
              background-color: rgba(255, 255, 0, 0.5);
          }
      </style>
  </head>
  <body>
      <div class="container">
          <h1>محرر نصوص PDF</h1>
          <div class="editor-panel">
              <input type="file" id="pdfFile" accept=".pdf" />
              <button onclick="loadPDF()">فتح PDF</button>
          </div>
          
          <div class="editor-panel" id="editPanel" style="display: none;">
              <h3>تعديل النص</h3>
              <p>النص المحدد: <span id="selectedText"></span></p>
              <input type="text" id="newText" class="text-input" placeholder="أدخل النص الجديد" />
              <button onclick="updateText()">تحديث النص</button>
              <button onclick="savePDF()">حفظ PDF</button>
          </div>

          <div class="canvas-container">
              <canvas id="pdfCanvas"></canvas>
              <div id="annotationLayer"></div>
          </div>
      </div>

      <script>
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          
          let currentPDF = null;
          let currentPage = 1;
          let currentScale = 1.5;
          let textItems = [];
          let selectedTextItem = null;

          async function loadPDF() {
              const fileInput = document.getElementById('pdfFile');
              const file = fileInput.files[0];
              if (!file) {
                  alert('الرجاء اختيار ملف PDF');
                  return;
              }

              const reader = new FileReader();
              reader.onload = async function(e) {
                  try {
                      const pdfData = new Uint8Array(e.target.result);
                      currentPDF = await pdfjsLib.getDocument(pdfData).promise;
                      await renderPage(currentPage);
                      document.getElementById('editPanel').style.display = 'block';
                  } catch (error) {
                      console.error('خطأ في تحميل PDF:', error);
                      alert('حدث خطأ في تحميل الملف');
                  }
              };
              reader.readAsArrayBuffer(file);
          }

          async function renderPage(pageNumber) {
              const page = await currentPDF.getPage(pageNumber);
              const viewport = page.getViewport({ scale: currentScale });

              const canvas = document.getElementById('pdfCanvas');
              const context = canvas.getContext('2d');
              canvas.height = viewport.height;
              canvas.width = viewport.width;

              await page.render({
                  canvasContext: context,
                  viewport: viewport
              }).promise;

              const textContent = await page.getTextContent();
              const annotationLayer = document.getElementById('annotationLayer');
              annotationLayer.innerHTML = '';
              annotationLayer.style.width = viewport.width + 'px';
              annotationLayer.style.height = viewport.height + 'px';

              textItems = [];
              textContent.items.forEach((item, index) => {
                  const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                  
                  const textElement = document.createElement('div');
                  textElement.className = 'text-element';
                  textElement.textContent = item.str;
                  textElement.style.left = `${tx[4]}px`;
                  textElement.style.top = `${tx[5]}px`;
                  textElement.style.fontSize = `${Math.sqrt((tx[0] * tx[0]) + (tx[1] * tx[1]))}px`;
                  textElement.style.transformOrigin = '0% 0%';
                  
                  textElement.addEventListener('click', () => selectText(index, textElement));
                  
                  annotationLayer.appendChild(textElement);
                  textItems.push({
                      element: textElement,
                      text: item.str,
                      font: item.fontName,
                      originalPosition: { x: tx[4], y: tx[5] }
                  });
              });
          }

          function selectText(index, element) {
              if (selectedTextItem) {
                  selectedTextItem.element.classList.remove('selected');
              }
              selectedTextItem = textItems[index];
              element.classList.add('selected');
              document.getElementById('selectedText').textContent = selectedTextItem.text;
              document.getElementById('newText').value = selectedTextItem.text;
          }

          function updateText() {
              if (!selectedTextItem) {
                  alert('الرجاء تحديد نص للتعديل');
                  return;
              }
              const newText = document.getElementById('newText').value;
              if (!newText) {
                  alert('الرجاء إدخال النص الجديد');
                  return;
              }
              
              selectedTextItem.element.textContent = newText;
              selectedTextItem.text = newText;
          }

          function savePDF() {
              const canvas = document.getElementById('pdfCanvas');
              const annotationLayer = document.getElementById('annotationLayer');
              
              // إنشاء canvas جديد للدمج
              const finalCanvas = document.createElement('canvas');
              finalCanvas.width = canvas.width;
              finalCanvas.height = canvas.height;
              const ctx = finalCanvas.getContext('2d');
              
              // نسخ الخلفية
              ctx.drawImage(canvas, 0, 0);
              
              // رسم النصوص المعدلة
              ctx.font = '16px Arial'; // يمكنك تعديل الخط حسب الحاجة
              textItems.forEach(item => {
                  ctx.fillText(item.text, item.originalPosition.x, item.originalPosition.y);
              });
              
              // تحميل الملف
              const dataUrl = finalCanvas.toDataURL('image/png');
              const link = document.createElement('a');
              link.download = 'modified_pdf.png';
              link.href = dataUrl;
              link.click();
          }
      </script>
  </body>
  </html>
